rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - custom OTP auth flow
    // Note: Security is enforced via server-side OTP verification
    // For development: Allow all operations on users collection
    match /users/{mobileNo} {
      allow read, write: if true;
    }

    // Tournaments collection - public read, controlled write
    match /tournaments/{tournamentId} {
      allow read: if true; // Public tournaments
      // Allow admins full write access
      allow create, delete: if request.auth != null && request.auth.token.role == 'admin';
      // Allow update for enrollment (current_players) or admin updates
      // Note: Users use custom OTP auth, not Firebase Auth
      allow update: if true;
    }

    // Payments collection - users can read their own, admins can read all
    match /payments/{paymentId} {
      // Allow read for payment history (filtered by user on client)
      allow read: if true;
      // Allow create for payment requests
      allow create: if true;
      // Only admins can update payment status
      allow update: if request.auth != null && request.auth.token.role == 'admin';
      allow delete: if request.auth != null && request.auth.token.role == 'admin';
    }

    // Admin collection - admin only
    match /admins/{adminId} {
      allow read, write: if request.auth != null && request.auth.token.role == 'admin';
    }

    // Notifications collection - users can read their own, admins can read all
    match /notifications/{notificationId} {
      // Allow read for all documents (client-side filtering by user_mobile)
      // This allows unauthenticated users to read notifications via queries
      allow read: if true;
      // Only admins can create notifications
      allow create: if request.auth != null && request.auth.token.role == 'admin';
      // Allow update for marking as read (users can update their own notifications)
      allow update: if true;
      // Only admins can delete notifications
      allow delete: if request.auth != null && request.auth.token.role == 'admin';
    }

    // Banners collection - public read, admin write
    match /banners/{bannerId} {
      allow read: if true; // Public banners (filtered by is_active on client)
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }

    // Settings collection - public read, admin write
    match /settings/{settingId} {
      allow read: if true; // Public settings (e.g., commission rates)
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }
  }
}


